#!/usr/bin/env bash
set -e

MODE="anthropic"
ARGS=()

CLAUDE_BINARY=$(PATH="${PATH//$HOME\/.local\/bin:/}" command -v claude)

if [ -z "$CLAUDE_BINARY" ]; then
  echo "Error: Could not find original app binary" >&2
  exit 1
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --copilot)
      MODE="copilot"
      shift
      ;;
    --anthropic)
      MODE="anthropic"
      shift
      ;;
    --ollama)
      MODE="ollama"
      shift
      ;;
    --model)
      DEFAULT_MODEL="$2"
      shift 2
      ARGS+=("--model" "$DEFAULT_MODEL")
      ;;
    --small-model)
      SMALL_MODEL="$2"
      shift 2
      ;;
    *)
      ARGS+=("$1")
      shift
      ;;
  esac
done

if [ "$MODE" = "anthropic" ]; then
  $CLAUDE_BINARY "${ARGS[@]}"
fi

if [ "$MODE" = "copilot" ]; then
  if command -v bun >/dev/null; then
    NODE_PACKAGE_MANAGER_TO_USE="bunx"
  elif command -v pnpm >/dev/null; then
    NODE_PACKAGE_MANAGER_TO_USE="pnpx"
  elif command -v npm >/dev/null; then
    NODE_PACKAGE_MANAGER_TO_USE="npx -y"
  else
    echo "Error: No supported package manager found (bun, pnpm, npm)." >&2
    exit 1
  fi


  if [ -z "$DEFAULT_MODEL" ]; then
    DEFAULT_MODEL="claude-sonnet-4.5"
  fi

  if [ -z "$SMALL_MODEL" ]; then
    SMALL_MODEL="claude-haiku-4.5"
  fi

  if ! lsof -i:4141 >/dev/null; then
    $NODE_PACKAGE_MANAGER_TO_USE @jeffreycao/copilot-api@latest start >/dev/null 2>&1 &
    COPILOT_PID=$!
  fi

  cleanup() {
    kill $COPILOT_PID 2>/dev/null || true
  }
  trap cleanup EXIT

  ANTHROPIC_BASE_URL="http://localhost:4141" \
    ANTHROPIC_API_KEY="" \
    ANTHROPIC_AUTH_TOKEN="dummy" \
    ANTHROPIC_DEFAULT_OPUS_MODEL="$DEFAULT_MODEL" \
    ANTHROPIC_DEFAULT_SONNET_MODEL="$DEFAULT_MODEL" \
    ANTHROPIC_DEFAULT_HAIKU_MODEL="$SMALL_MODEL" \
    $CLAUDE_BINARY "${ARGS[@]}"
fi

if [ "$MODE" = "ollama" ]; then
  if ! command -v ollama >/dev/null; then
    echo "Error: Ollama CLI not found. Please install Ollama to use this mode." >&2
    exit 1
  fi

  if [ -z "$DEFAULT_MODEL" ]; then
    DEFAULT_MODEL="gpt-oss"
  fi

  if [ -z "$SMALL_MODEL" ]; then
    SMALL_MODEL="gpt-oss"
  fi

  ANTHROPIC_BASE_URL="http://localhost:11434" \
    ANTHROPIC_API_KEY="" \
    ANTHROPIC_AUTH_TOKEN="ollama" \
    ANTHROPIC_DEFAULT_OPUS_MODEL="$DEFAULT_MODEL" \
    ANTHROPIC_DEFAULT_SONNET_MODEL="$DEFAULT_MODEL" \
    ANTHROPIC_DEFAULT_HAIKU_MODEL="$SMALL_MODEL" \
    $CLAUDE_BINARY "${ARGS[@]}"
fi
